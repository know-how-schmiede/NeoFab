<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>NeoFab Order PDF</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; color: #222; }
    header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #444; padding-bottom: 8px; margin-bottom: 20px; }
    h1 { font-size: 20px; margin: 0; }
    h2 { font-size: 16px; margin: 16px 0 8px; }
    .meta { font-size: 12px; color: #666; }
    .section { margin-bottom: 16px; }
    .field { margin-bottom: 2px; }
    .label {
      font-weight: bold;
      font-size: 1.4em;
      display: inline-block;
      min-width: 180px;   /* feste Breite für saubere Ausrichtung */
      vertical-align: top;
    }   
    .value {
      display: inline;     /* kein Zeilenumbruch mehr */
      margin-left: 4px;    /* kleiner Abstand hinter dem Label */
    }
    .page-break { page-break-before: always; }
    .messages { border-top: 1px solid #ddd; padding-top: 8px; }
    .chat { display: flex; flex-direction: column; gap: 8px; }
    .msg-row { display: flex; flex-direction: column; align-items: flex-start; gap: 2px; }
    .msg-row.admin { align-items: flex-end; text-align: right; }
    .meta-line { font-size: 11px; color: #555; margin: 0; }
    .bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 10px;
      background: #f5f5f5;
      border: 1px solid #e0e0e0;
      white-space: pre-wrap;
      margin: 0;
    }
    .admin .bubble { background: #e8f1ff; border-color: #c4dafd; }
    .image-thumb {
      max-width: 200px;
      height: auto;
      border: 1px solid #ddd;
      padding: 3px;
      margin: 6px 0;
    }
    .print-job-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-bottom: 8px;
    }
    .print-job-table th,
    .print-job-table td {
      padding: 4px 6px;
      vertical-align: top;
      text-align: left;
    }
    .print-job-name th {
      background: #f2f2f2;
      font-size: 13px;
      border: 1px solid #ddd;
      border-bottom: none;
    }
    .print-job-name .meta { font-weight: normal; }
    .print-job-note td {
      background: #fafafa;
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
    .print-job-subhead th {
      background: #fafafa;
      font-size: 11px;
      color: #555;
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
    .print-job-data td {
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="meta">{{ app_name }} - Version {{ app_version }}</div>
      <div class="meta">{{ t("pdf_generated_label") }}: {{ pdf_generated_at }}</div>
      <h1>Order #{{ order_dict.id }} - {{ order_dict.title }}</h1>
      <hr>
    </div>
  </header>

<div class="section">

  <!-- Status + Owner -->
  <div class="row">
    <div class="field">
      <span class="label">{{ t("order_status_label") }}:</span><br>
      <span class="value">{{ order_dict.status }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("order_owner_label") }}:</span><br>
      <span class="value">{{ order_dict.owner }}</span>
    </div>
  </div>

  <!-- Anrede + Vorname + Nachname -->
  <div class="row">
    <div class="field">
      <span class="label">{{ t("label_salutation") }}:</span><br>
      <span class="value">{{ order_dict.salutation }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("label_first_name") }}:</span><br>
      <span class="value">{{ order_dict.first_name }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("label_last_name") }}:</span><br>
      <span class="value">{{ order_dict.last_name }}</span>
    </div>
  </div>

  <!-- Adresse (volle Breite) -->
  <div class="row">
    <div class="field" style="width:100%;">
      <span class="label">{{ t("label_address") }}:</span><br>
      <span class="value">{{ order_dict.address }}</span>
    </div>
  </div>

  <!-- Position + Studiengang -->
  <div class="row">
    <div class="field">
      <span class="label">{{ t("label_position") }}:</span><br>
      <span class="value">{{ order_dict.position }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("label_study_program") }}:</span><br>
      <span class="value">{{ order_dict.study_program }}</span>
    </div>
  </div>

  <!-- Material + Farbe + Kostenstelle -->
  <div class="row">
    <div class="field">
      <span class="label">{{ t("order_material_label") }}:</span><br>
      <span class="value">{{ order_dict.material }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("order_color_label") }}:</span><br>
      <span class="value">{{ order_dict.color }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("order_cost_center_label") }}:</span><br>
      <span class="value">{{ order_dict.cost_center }}</span>
    </div>
  </div>

  <!-- Erstellt + Aktualisiert -->
  <div class="row">
    <div class="field">
      <span class="label">{{ t("order_created_label") }}:</span>
      <span class="value">{{ order_dict.created_at }}</span>
    </div>

    <div class="field">
      <span class="label">{{ t("order_updated_label") }}:</span>
      <span class="value">{{ order_dict.updated_at }}</span>
    </div>
  </div>

</div>


  <div class="section page-break">
    <h2>{{ t("tab_project") }}</h2>
    <p>Order #{{ order_dict.id }} - {{ order_dict.title }}</p>
    <hr>
    <div class="field"><span class="label">{{ t("order_summary_short") }}:</span><br> {{ order_dict.summary_short }}</div>
    <div class="field"><span class="label">{{ t("order_summary_long") }}:</span><br> {{ order_dict.summary_long }}</div>
    <div class="field"><span class="label">{{ t("order_description_label") }}:</span><br> {{ order_dict.description }}</div>
    <div class="field"><span class="label">{{ t("order_project_purpose") }}:</span><br> {{ order_dict.project_purpose }}</div>
    <div class="field"><span class="label">{{ t("order_project_use_case") }}:</span><br> {{ order_dict.project_use_case }}</div>
    <div class="field"><span class="label">{{ t("order_learning_points") }}:</span><br> {{ order_dict.learning_points }}</div>
    <div class="field"><span class="label">{{ t("order_background_info") }}:</span><br> {{ order_dict.background_info }}</div>
    <div class="field"><span class="label">{{ t("order_project_url") }}:</span><br> {{ order_dict.project_url }}</div>
    <div class="field"><span class="label">{{ t("order_tags") }}:</span><br> {{ order_dict.tags }}</div>
    <div class="field"><span class="label">{{ t("order_public_sharing") }}:</span>
      <ul style="margin: 4px 0 0 0; padding-left: 18px;">
        <li>{{ t("order_allow_poster") }}: {{ "Yes" if order_dict.public_allow_poster else "No" }}</li>
        <li>{{ t("order_allow_web") }}: {{ "Yes" if order_dict.public_allow_web else "No" }}</li>
        <li>{{ t("order_allow_social") }}: {{ "Yes" if order_dict.public_allow_social else "No" }}</li>
      </ul>
    </div>
  </div>

  <div class="section messages page-break">
    <h2>{{ t("messages_header") }}</h2>
    <p>Order #{{ order_dict.id }} - {{ order_dict.title }}</p>
    <hr>
    {% if messages %}
      <div class="chat">
        {% for m in messages %}
          {% set is_admin = m.role == 'admin' %}
          <div class="msg-row {% if is_admin %}admin{% endif %}">
            <div class="meta-line">{{ m.author }} — {{ m.created_at }}</div>
            <div class="bubble">{{ m.content }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="meta">{{ t("messages_empty") }}</div>
    {% endif %}
  </div>

  <div class="section page-break">
    <h2>{{ t("files_header") }}</h2>
    <p>Order #{{ order_dict.id }} - {{ order_dict.title }}</p>
    <hr>
    {% if files %}
      <ul>
        {% for f in files %}
          <li>
            <strong>{{ f.name }}</strong>
            {% if f.file_type %} ({{ f.file_type }}){% endif %}
            {% if f.thumb_data_uri %}
              <br>
              <img src="{{ f.thumb_data_uri }}" alt="{{ f.name }}" class="image-thumb">
            {% endif %}
            <br> {{ t("files_label_quantity") }}: {{ f.quantity }}
            {% if f.note %} <br> {{ t("files_label_note") }}: {{ f.note }}{% endif %}
            {% if f.uploaded_at %} – {{ f.uploaded_at }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="meta">{{ t("files_none") }}</div>
    {% endif %}
  </div>

  <div class="section page-break">
    <h2>{{ t("print_jobs_header") }}</h2>
    <p>Order #{{ order_dict.id }} - {{ order_dict.title }}</p>
    <hr>
    {% if print_jobs %}
      {% for job in print_jobs %}
        <table class="print-job-table">
          <tbody>
            <tr class="print-job-name">
              <th colspan="4">
                {{ job.name }}
                <div class="meta">
                  {% set parts = [] %}
                  {% if job.filesize %}{% set _ = parts.append(((job.filesize / 1024)|round(1)) ~ " KB") %}{% endif %}
                  {% if job.uploaded_at %}{% set _ = parts.append(job.uploaded_at) %}{% endif %}
                  {{ " | ".join(parts) }}
                </div>
              </th>
            </tr>
            <tr class="print-job-note">
              <td colspan="4">{{ t("print_jobs_table_note") }}: {{ job.note or "-" }}</td>
            </tr>
            <tr class="print-job-subhead">
              <th>{{ t("print_jobs_table_status") }}</th>
              <th>{{ t("print_jobs_table_started_at") }}</th>
              <th>{{ t("print_jobs_table_duration") }}</th>
              <th>{{ t("print_jobs_table_filament") }}</th>
            </tr>
            <tr class="print-job-data">
              <td>{{ job.status }}</td>
              <td>{{ job.started_at if job.started_at else "-" }}</td>
              <td>
                {% if job.duration_min is not none %}
                  {{ job.duration_min }} {{ t("print_jobs_unit_minutes") }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% set filament = [] %}
                {% if job.filament_m is not none %}{% set _ = filament.append((job.filament_m|round(1)) ~ " m") %}{% endif %}
                {% if job.filament_g is not none %}{% set _ = filament.append((job.filament_g|round(1)) ~ " g") %}{% endif %}
                {{ " / ".join(filament) if filament else "-" }}
              </td>
            </tr>
          </tbody>
        </table>
      {% endfor %}
    {% else %}
      <div class="meta">{{ t("print_jobs_none") }}</div>
    {% endif %}
  </div>

  <div class="section page-break">
    <h2>{{ t("images_header") }}</h2>
    <p>Order #{{ order_dict.id }} - {{ order_dict.title }}</p>
    <hr>
    {% if images %}
      <ul>
        {% for img in images %}
          <li>
            <strong>{{ img.name }}</strong>
            {% if img.thumb_data_uri %}
              <br>
              <img src="{{ img.thumb_data_uri }}" alt="{{ img.name }}" class="image-thumb">
            {% endif %}
            {% if img.uploaded_at %} <br> {{ img.uploaded_at }}{% endif %}
            {% if img.filesize %} – {{ (img.filesize / 1024)|round(1) }} KB{% endif %}
            {% if img.note %} <br> {{ t("images_label_note") }}: {{ img.note }}{% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="meta">{{ t("images_none") }}</div>
    {% endif %}
  </div>
</body>
</html>
