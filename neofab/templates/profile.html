{% extends "base.html" %}

{% block title %}{{ t("nav_profile") }}{% endblock %}

{% block content %}

<div class="card mb-3">
  <div class="card-header">
    <h2 class="h5 mb-0">
      <i class="bi bi-person-badge me-1"></i>
      {{ t("nav_profile") }}
    </h2>
  </div>

  <div class="card-body">
    <form method="post" novalidate autocomplete="off">
      <div class="row g-3">

        <!-- Email -->
        <div class="col-md-6">
          <label for="email" class="form-label">
            <i class="bi bi-envelope me-1"></i>
            {{ t("label_email") }}*
          </label>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            value="{{ user.email }}"
            required
          >
        </div>

        <!-- Password -->
        <div class="col-md-3">
          <label for="password" class="form-label">
            <i class="bi bi-key me-1"></i>
            {{ t("admin_user_label_new_password") }}
          </label>
          <input
            type="password"
            class="form-control"
            id="password"
            name="password"
            placeholder="{{ t('profile_password_placeholder') }}"
            autocomplete="new-password"
          >
        </div>

        <!-- Password Repeat -->
        <div class="col-md-3">
          <label for="password2" class="form-label">
            {{ t("profile_password_repeat") }}
          </label>
          <input
            type="password"
            class="form-control"
            id="password2"
            name="password2"
            autocomplete="new-password"
          >
        </div>

        <!-- Language -->
        <div class="col-md-6">
          <label for="language" class="form-label">
            {{ t("label_language") }}
          </label>
          <select class="form-select" id="language" name="language">
            <option value="en" {% if user.language == 'en' %}selected{% endif %}>English</option>
            <option value="de" {% if user.language == 'de' %}selected{% endif %}>Deutsch</option>
            <option value="fr" {% if user.language == 'fr' %}selected{% endif %}>Français</option>
          </select>
        </div>

        <!-- Salutation -->
        <div class="col-md-4">
          <label for="salutation" class="form-label">
            {{ t("label_salutation") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="salutation"
            name="salutation"
            value="{{ user.salutation or '' }}"
          >
        </div>

        <!-- First / Last Name -->
        <div class="col-md-4">
          <label for="first_name" class="form-label">
            {{ t("label_first_name") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="first_name"
            name="first_name"
            value="{{ user.first_name or '' }}"
          >
        </div>
        <div class="col-md-4">
          <label for="last_name" class="form-label">
            {{ t("label_last_name") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="last_name"
            name="last_name"
            value="{{ user.last_name or '' }}"
          >
        </div>

        <!-- Address -->
        <div class="col-12">
          <label for="address" class="form-label">
            {{ t("label_address") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="address"
            name="address"
            value="{{ user.address or '' }}"
          >
        </div>

        <!-- Position / Cost Center -->
        <div class="col-md-6">
          <label for="position" class="form-label">
            {{ t("label_position") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="position"
            name="position"
            value="{{ user.position or '' }}"
          >
        </div>
        <div class="col-md-6">
          <label for="cost_center" class="form-label">
            {{ t("label_cost_center") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="cost_center"
            name="cost_center"
            value="{{ user.cost_center or '' }}"
          >
        </div>

        <!-- Study Program -->
        <div class="col-md-6">
          <label for="study_program" class="form-label">
            {{ t("label_study_program") }}
          </label>
          <input
            type="text"
            class="form-control"
            id="study_program"
            name="study_program"
            value="{{ user.study_program or '' }}"
          >
        </div>

        <!-- Note -->
        <div class="col-12">
          <label for="note" class="form-label">
            {{ t("label_note") }}
          </label>
          <textarea
            class="form-control"
            id="note"
            name="note"
            rows="3"
          >{{ user.note or '' }}</textarea>
        </div>

      </div>

      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>
          {{ t("btn_save_changes") }}
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          {{ t("btn_back_dashboard") }}
        </a>
      </div>
    </form>
  </div>
</div>

<div class="card">
  <div class="card-header">
    <h3 class="h6 mb-0 d-flex align-items-center">
      <i class="bi bi-archive me-2"></i>
      {{ t("announcements_archive_header") }}
    </h3>
  </div>
  <div class="card-body">
    {% if announcements_read %}
      <div class="list-group">
        {% for a in announcements_read %}
          {% set meta = announcement_priority_meta.get(a.priority, announcement_priority_meta.get("info")) %}
          <div class="list-group-item">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-semibold">
                  <i class="bi {{ meta["icon"] }} {{ meta["class"] }} me-1"></i>
                  {{ a.title }}
                </div>
                <div class="text-muted small">
                  {{ t(meta["label"]) }}{% if a.created_at %} · {{ a.created_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
                </div>
              </div>
              <div class="d-flex gap-2">
                {% if current_user.role == 'admin' %}
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#announcementModal"
                          data-mode="edit"
                          data-announcement-id="{{ a.id }}"
                          data-announcement-title="{{ a.title|e }}"
                          data-announcement-body="{{ a.body|e }}"
                          data-announcement-priority="{{ a.priority }}">
                    <i class="bi bi-pencil me-1"></i>{{ t("btn_edit") }}
                  </button>
                {% endif %}
              </div>
            </div>
            <div class="mt-2">
              {{ render_markdown(a.body) }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="mb-0 text-muted">{{ t("announcements_archive_none") }}</p>
    {% endif %}
  </div>
</div>

{% if current_user.role == 'admin' %}
  <div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="announcementModalLabel">{{ t("announcements_modal_edit_title") }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
        </div>
        <div class="modal-body">
        <form method="post" action="{{ url_for('announcement_update') }}">
          <input type="hidden" name="next" value="{{ url_for('profile') }}">
          <input type="hidden" name="announcement_id" id="announcement_id" value="">
            <div class="mb-3">
              <label for="announcement_title" class="form-label">{{ t("announcement_title_label") }}</label>
              <input class="form-control"
                     type="text"
                     id="announcement_title"
                     name="announcement_title"
                     maxlength="200"
                     required>
            </div>
            <div class="mb-3">
              <label for="announcement_priority" class="form-label">{{ t("announcement_priority_label") }}</label>
              <select id="announcement_priority" name="announcement_priority" class="form-select">
                <option value="info">{{ t("announcement_priority_info") }}</option>
                <option value="notice">{{ t("announcement_priority_notice") }}</option>
                <option value="important">{{ t("announcement_priority_important") }}</option>
                <option value="warning">{{ t("announcement_priority_warning") }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="announcement_body" class="form-label">{{ t("announcement_body_label") }}</label>
              <textarea class="form-control"
                        id="announcement_body"
                        name="announcement_body"
                        rows="4"
                        required></textarea>
            </div>
            <div class="d-flex justify-content-between align-items-center gap-2">
              <div>
                <details class="markdown-help d-inline-block">
                  <summary class="btn btn-outline-secondary btn-sm d-inline-flex align-items-center">
                    <i class="bi bi-question-circle me-1"></i>
                    {{ t("btn_help") }}
                  </summary>
                  <div class="small text-muted mt-2">
                    <div class="fw-semibold">{{ t("markdown_help_title") }}</div>
                    <div>{{ t("markdown_help_bold") }}</div>
                    <div>{{ t("markdown_help_italic") }}</div>
                    <div>{{ t("markdown_help_list") }}</div>
                    <div>{{ t("markdown_help_numbered") }}</div>
                    <div>{{ t("markdown_help_code") }}</div>
                    <div>{{ t("markdown_help_link") }}</div>
                  </div>
                </details>
              </div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  {{ t("btn_cancel") }}
                </button>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-save me-1"></i>{{ t("btn_save_changes") }}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
{% if current_user.role == 'admin' %}
<script>
(function() {
  const modalEl = document.getElementById("announcementModal");
  if (!modalEl) return;

  modalEl.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    if (!button) return;

    const id = button.getAttribute("data-announcement-id") || "";
    const title = button.getAttribute("data-announcement-title") || "";
    const body = button.getAttribute("data-announcement-body") || "";
    const priority = button.getAttribute("data-announcement-priority") || "info";

    const idInput = modalEl.querySelector("#announcement_id");
    const titleInput = modalEl.querySelector("#announcement_title");
    const bodyInput = modalEl.querySelector("#announcement_body");
    const priorityInput = modalEl.querySelector("#announcement_priority");

    if (idInput) idInput.value = id;
    if (titleInput) titleInput.value = title;
    if (bodyInput) bodyInput.value = body;
    if (priorityInput) priorityInput.value = priority;
  });
})();
</script>
{% endif %}
{% endblock %}
