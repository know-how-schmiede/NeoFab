{% extends "base.html" %}

{% block title %}Order #{{ order.id }} - NeoFab{% endblock %}

{% block extra_head %}
{{ super() }}
<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
  }
}
</script>
{% endblock %}

{% block content %}

<!-- ORDER FORMULAR / DETAILS -->
<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h2 class="h5 mb-0 d-flex align-items-center">
      <i class="bi bi-file-earmark-text me-2"></i>
      Order #{{ order.id }} - {{ order.title }}
    </h2>
    <div class="d-flex align-items-center gap-2">
      {% if order.status not in ['completed', 'cancelled'] and (current_user.role == 'admin' or order.user_id == current_user.id) %}
        <form method="post" class="d-inline" onsubmit="return confirm('{{ t('confirm_cancel_order') }}');">
          <input type="hidden" name="action" value="cancel_order">
          <button type="submit" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-x-circle me-1"></i>{{ t("btn_cancel_order") }}
          </button>
        </form>
      {% endif %}
      {% if current_user.role == 'admin' %}
        <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin_order_pdf', order_id=order.id) }}">
          <i class="bi bi-file-earmark-arrow-down me-1"></i>{{ t("btn_download_pdf") }}
        </a>
      {% endif %}
    </div>
  </div>

  <div class="card-body">
    <form method="post" novalidate>
      <input type="hidden" name="action" value="update_order">

      <ul class="nav nav-tabs mb-3" id="orderTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-tab-pane" type="button" role="tab" aria-controls="general-tab-pane" aria-selected="true">
            {{ t("tab_general") }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="project-tab" data-bs-toggle="tab" data-bs-target="#project-tab-pane" type="button" role="tab" aria-controls="project-tab-pane" aria-selected="false">
            {{ t("tab_project") }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files-tab-pane" type="button" role="tab" aria-controls="files-tab-pane" aria-selected="false">
            {{ t("tab_files") }}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="print-jobs-tab" data-bs-toggle="tab" data-bs-target="#print-jobs-tab-pane" type="button" role="tab" aria-controls="print-jobs-tab-pane" aria-selected="false">
            {{ t("tab_print_jobs") }}
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <div class="tab-pane fade show active" id="general-tab-pane" role="tabpanel" aria-labelledby="general-tab">
          <div class="row g-3">

        <!-- Titel -->
        <div class="col-12 col-md-8">
          <label for="title" class="form-label">
            <i class="bi bi-card-text me-1"></i>
            {{ t("order_title_label") }}*
          </label>
          <input
            type="text"
            class="form-control"
            id="title"
            name="title"
            required
            value="{{ order.title }}"
          >
        </div>

        <!-- Status & Meta-Infos -->
        <div class="col-12 col-md-4">
          <label class="form-label">
            <i class="bi bi-flag me-1"></i>
            {{ t("order_status_label") }}
          </label>

          {% if current_user.role == 'admin' %}
            <select
              id="status"
              name="status"
              class="form-select"
            >
              {% for value, label in order_statuses %}
                <option value="{{ value }}"
                        {% if order.status == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
          {% else %}
            <div>
              {% set status_style = status_styles.get(order.status, "bg-light text-dark") %}
              <span class="badge {{ status_style }}">
                {{ status_labels.get(order.status, order.status) }}
              </span>
            </div>
          {% endif %}
        </div>

        <!-- Beschreibung -->
        <div class="col-12">
          <label for="description" class="form-label">
            <i class="bi bi-journal-text me-1"></i>
            {{ t("order_description_label") }}
          </label>
          <textarea
            class="form-control"
            id="description"
            name="description"
            rows="4"
          >{{ order.description or '' }}</textarea>
        </div>

        <!-- Cost Center -->
        <div class="col-md-6">
          <label for="cost_center_id" class="form-label">
            <i class="bi bi-bank me-1"></i>
            {{ t("order_cost_center_label") }}
          </label>
          <select
            id="cost_center_id"
            name="cost_center_id"
            class="form-select"
          >
            <option value="">{{ t("select_placeholder") }}</option>
            {% for cc in cost_centers %}
              <option value="{{ cc.id }}"
                      {% if order.cost_center_id == cc.id %}selected{% endif %}>
                {{ cc.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Material -->
        <div class="col-md-6">
          <label for="material_id" class="form-label">
            <i class="bi bi-box-seam me-1"></i>
            {{ t("order_material_label") }}
          </label>
          <select
            id="material_id"
            name="material_id"
            class="form-select"
          >
            <option value="">{{ t("select_placeholder") }}</option>
            {% for m in materials %}
              <option value="{{ m.id }}"
                      {% if order.material_id == m.id %}selected{% endif %}>
                {{ m.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Farbe + Vorschau -->
        <div class="col-md-6">
          <label for="color_id" class="form-label">
            <i class="bi bi-palette me-1"></i>
            {{ t("order_color_label") }}
          </label>
          <div class="input-group">
            <select
              id="color_id"
              name="color_id"
              class="form-select"
              onchange="updateColorPreview()"
            >
              <option value="">{{ t("select_placeholder") }}</option>
              {% for c in colors %}
                <option value="{{ c.id }}"
                        data-hex="{{ c.hex_code if c.hex_code else '' }}"
                        {% if order.color_id == c.id %}selected{% endif %}>
                  {{ c.name }}{% if c.hex_code %} ({{ c.hex_code }}){% endif %}
                </option>
              {% endfor %}
            </select>
            <span class="input-group-text p-0">
              <div id="colorPreview"
                   style="
                     width: 32px;
                     height: 32px;
                     border-radius: 4px;
                     border: 1px solid #ccc;
                     background-color:
                       {% if order.color and order.color.hex_code %}
                         {{ order.color.hex_code }}
                       {% else %}
                         transparent
                       {% endif %};
                   ">
              </div>
            </span>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">
            <i class="bi bi-person-circle me-1"></i>
            {{ t("order_owner_label") }}
          </label>
          <div class="form-control-plaintext">
            {{ order.user.email }}
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">
            <i class="bi bi-clock-history me-1"></i>
            {{ t("order_timestamps_label") }}
          </label>
          <div class="small text-muted">
            <div>{{ t("order_created_label") }}: {{ order.created_at.strftime('%Y-%m-%d %H:%M') if order.created_at else '-' }}</div>
            <div>{{ t("order_updated_label") }}: {{ order.updated_at.strftime('%Y-%m-%d %H:%M') if order.updated_at else '-' }}</div>
          </div>
        </div>

      </div>

        </div>

        <div class="tab-pane fade" id="project-tab-pane" role="tabpanel" aria-labelledby="project-tab">
          <div class="row g-3">

            <!-- Public sharing -->
            <div class="col-md-6">
              <label class="form-label d-block">
                <i class="bi bi-megaphone me-1"></i>
                {{ t("order_public_sharing") }}
              </label>
              {% set allow_poster_checked = order.public_allow_poster if order.public_allow_poster is not none else true %}
              {% set allow_web_checked = order.public_allow_web if order.public_allow_web is not none else true %}
              {% set allow_social_checked = order.public_allow_social if order.public_allow_social is not none else true %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="public_allow_poster" name="public_allow_poster" {% if allow_poster_checked %}checked{% endif %}>
                <label class="form-check-label" for="public_allow_poster">{{ t("order_allow_poster") }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="public_allow_web" name="public_allow_web" {% if allow_web_checked %}checked{% endif %}>
                <label class="form-check-label" for="public_allow_web">{{ t("order_allow_web") }}</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="public_allow_social" name="public_allow_social" {% if allow_social_checked %}checked{% endif %}>
                <label class="form-check-label" for="public_allow_social">{{ t("order_allow_social") }}</label>
              </div>
            </div>

            <!-- Anzeige-Name -->
            <div class="col-md-6">
              <label for="public_display_name" class="form-label">{{ t("order_display_name") }}</label>
              <input type="text" class="form-control" id="public_display_name" name="public_display_name" maxlength="200" value="{{ order.public_display_name or '' }}" placeholder="{{ t('project_public_display_placeholder') }}">
            </div>

            <!-- Projekt-Kurzbeschreibung -->
            <div class="col-md-6">
              <label for="summary_short" class="form-label">{{ t("order_summary_short") }}</label>
              <input type="text" class="form-control" id="summary_short" name="summary_short" maxlength="300" value="{{ order.summary_short or '' }}" placeholder="{{ t('project_summary_short_placeholder') }}">
            </div>

            <!-- Projektstory -->
            <div class="col-12">
              <label for="summary_long" class="form-label">{{ t("order_summary_long") }}</label>
              <textarea class="form-control" id="summary_long" name="summary_long" rows="3" placeholder="{{ t('project_summary_long_placeholder') }}">{{ order.summary_long or '' }}</textarea>
            </div>

            <div class="col-md-6">
              <label for="project_purpose" class="form-label">{{ t("order_project_purpose") }}</label>
              <textarea class="form-control" id="project_purpose" name="project_purpose" rows="2" placeholder="{{ t('project_purpose_placeholder') }}">{{ order.project_purpose or '' }}</textarea>
            </div>
            <div class="col-md-6">
              <label for="project_use_case" class="form-label">{{ t("order_project_use_case") }}</label>
              <textarea class="form-control" id="project_use_case" name="project_use_case" rows="2" placeholder="{{ t('project_use_case_placeholder') }}">{{ order.project_use_case or '' }}</textarea>
            </div>

            <div class="col-md-6">
              <label for="learning_points" class="form-label">{{ t("order_learning_points") }}</label>
              <textarea class="form-control" id="learning_points" name="learning_points" rows="2" placeholder="{{ t('project_learning_points_placeholder') }}">{{ order.learning_points or '' }}</textarea>
            </div>
            <div class="col-md-6">
              <label for="background_info" class="form-label">{{ t("order_background_info") }}</label>
              <textarea class="form-control" id="background_info" name="background_info" rows="2" placeholder="{{ t('project_background_info_placeholder') }}">{{ order.background_info or '' }}</textarea>
            </div>

            <div class="col-md-6">
              <label for="project_url" class="form-label">{{ t("order_project_url") }}</label>
              <input type="url" class="form-control" id="project_url" name="project_url" maxlength="300" value="{{ order.project_url or '' }}" placeholder="{{ t('project_url_placeholder') }}">
            </div>

            <div class="col-md-6">
              <label for="tags" class="form-label">{{ t("order_tags") }}</label>
              <input type="text" class="form-control" id="tags" name="tags" maxlength="300" value="{{ tags_value }}" placeholder="{{ t('project_tags_placeholder') }}">
            </div>

          </div>
        </div>
      </div>

      <!-- Buttons -->
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>
          {{ t("btn_save_changes") }}
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          {{ t("btn_back_dashboard") }}
        </a>
      </div>

    </form>
  </div>
</div>

<!-- Files Tab Pane (outside the update form) -->
<div class="tab-content mt-3">
  <div class="tab-pane fade" id="files-tab-pane" role="tabpanel" aria-labelledby="files-tab">

    <div class="alert alert-info mb-3">
      {{ t("files_note_immediate") }}
    </div>

    <!-- Modelle -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="h6 mb-0 d-flex align-items-center">
          <i class="bi bi-boxes me-2"></i>
          {{ t("files_header") }}
        </h3>
      </div>
      <div class="card-body">

        {# Liste aller Dateien zu diesem Auftrag #}
        {% if order.files %}
          <ul class="list-group mb-3">
            {% for f in order.files %}
             {% set file_type = (f.file_type or '').lower() %}
             {% set can_preview = file_type == 'stl' %}
             {% if file_type == 'stl' %}
               {% set thumb_sm_url = url_for('order_file_thumbnail', order_id=order.id, file_id=f.id, size='sm') %}
               {% set thumb_lg_url = url_for('order_file_thumbnail', order_id=order.id, file_id=f.id, size='lg') %}
             {% else %}
               {% set thumb_sm_url = '' %}
               {% set thumb_lg_url = '' %}
             {% endif %}
             {% set preview_tooltip = t('files_preview_open') %}
             {% if file_type == '3mf' %}
               {% set preview_tooltip = t('files_preview_3mf_unavailable') %}
             {% endif %}
             <li class="list-group-item">
              <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                <div class="d-flex gap-3 align-items-start">
                  <div class="flex-shrink-0">
                    {% if can_preview %}
                      <button
                        type="button"
                        class="model-thumb-button"
                        data-model-preview="true"
                        data-preview-file-id="{{ f.id }}"
                        data-preview-order-id="{{ order.id }}"
                        data-preview-url="{{ url_for('order_file_preview', order_id=order.id, file_id=f.id) }}"
                        data-preview-name="{{ f.original_name }}"
                        data-preview-note="{{ f.note or '' }}"
                        data-preview-type="{{ file_type }}"
                        data-preview-poster="{{ thumb_lg_url }}"
                        data-preview-thumb-sm="{{ thumb_sm_url }}"
                        data-preview-thumb-lg="{{ thumb_lg_url }}"
                        data-preview-color-id="{{ f.color_id or '' }}"
                        aria-label="{{ preview_tooltip }}"
                        title="{{ preview_tooltip }}"
                      >
                        {% if thumb_sm_url %}
                          <img
                            src="{{ thumb_sm_url }}"
                            alt="{{ f.original_name }}"
                            class="model-thumb-img"
                            loading="lazy"
                            onerror="this.classList.add('d-none'); this.nextElementSibling.classList.remove('d-none');"
                          >
                          <span class="model-thumb-placeholder d-none">
                            <span class="model-thumb-label">{{ (file_type or '3D')|upper }}</span>
                          </span>
                        {% else %}
                          <span class="model-thumb-placeholder">
                            <span class="model-thumb-label">{{ (file_type or '3D')|upper }}</span>
                          </span>
                        {% endif %}
                      </button>
                    {% elif file_type == '3mf' %}
                      <span class="model-thumb-placeholder" title="{{ preview_tooltip }}">
                        <span class="model-thumb-label">{{ (file_type or '3D')|upper }}</span>
                      </span>
                    {% else %}
                      <div class="model-thumb-placeholder">
                        <i class="bi bi-box"></i>
                      </div>
                    {% endif %}
                  </div>
                  <div>
                    <div>
                      <strong>{{ f.original_name }}</strong>
                      {% if f.file_type %}
                        <span class="badge 
                              {% if f.file_type.lower() == 'stl' %}bg-info
                              {% elif f.file_type.lower() == '3mf' %}bg-success
                              {% else %}bg-secondary
                              {% endif %}
                              ms-2">
                          {{ f.file_type|upper }}
                        </span>
                      {% endif %}
                      {% set qty = f.quantity or 1 %}
                      {% if qty %}
                        <span class="badge bg-secondary ms-1">&times;{{ qty }}</span>
                      {% endif %}
                    </div>
                    <small class="text-muted">
                      {% set parts = [] %}
                      {% if f.filesize %}
                        {% set _ = parts.append(((f.filesize / 1024)|round(1)) ~ " KB") %}
                      {% endif %}
                      {% if f.uploaded_at %}
                        {% set _ = parts.append("uploaded " ~ f.uploaded_at.strftime("%Y-%m-%d %H:%M")) %}
                      {% endif %}
                      {% if f.note %}
                        {% set _ = parts.append(f.note) %}
                      {% endif %}
                      {{ " | ".join(parts) }}
                    </small>
                  </div>
                </div>

                <div class="d-flex gap-2">
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#fileEditModal"
                          data-file-id="{{ f.id }}"
                          data-file-name="{{ f.original_name }}"
                          data-file-note="{{ f.note or '' }}"
                          data-file-quantity="{{ f.quantity or 1 }}">
                    <i class="bi bi-pencil me-1"></i>
                    {{ t("btn_edit") }}
                  </button>
                  <a class="btn btn-sm btn-outline-primary"
                    href="{{ url_for('download_order_file', order_id=order.id, file_id=f.id) }}">
                    <i class="bi bi-download me-1"></i>
                    {{ t("btn_download") }}
                  </a>

                  <form method="post"
                        onsubmit="return confirm('{{ t('confirm_delete_file') }}');">
                    <input type="hidden" name="action" value="delete_file">
                    <input type="hidden" name="file_id" value="{{ f.id }}">
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="bi bi-trash me-1"></i>
                      {{ t("btn_delete") }}
                    </button>
                  </form>
                </div>
              </div>
            </li>
          {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">
            {{ t("files_none") }}
          </p>
        {% endif %}

        {# Upload weiterer Dateien - eigenes Formular #}
        <form method="post" enctype="multipart/form-data" class="mt-2">
          <input type="hidden" name="action" value="upload_file">

          <div class="mb-2">
            <label for="model_file" class="form-label">
              <i class="bi bi-upload me-1"></i>
              {{ t("files_upload_label") }}
            </label>
            <input class="form-control"
                   type="file"
                   id="model_file"
                   name="model_file"
                   accept=".stl,.3mf">
            <div class="form-text">
              {{ t("files_upload_hint") }}
            </div>
          </div>

          <div class="row g-2">
            <div class="col-md-8">
              <label for="file_note" class="form-label">{{ t("files_label_note") }}</label>
              <input
                type="text"
                class="form-control"
                id="file_note"
                name="file_note"
                maxlength="255"
                placeholder="{{ t('files_note_placeholder') }}"
              >
            </div>
            <div class="col-md-4">
              <label for="file_quantity" class="form-label">{{ t("files_label_quantity") }}</label>
              <input
                type="number"
                class="form-control"
                id="file_quantity"
                name="file_quantity"
                min="1"
                step="1"
                value="1"
              >
            </div>
          </div>

          <button type="submit" class="btn btn-secondary btn-sm">
            <i class="bi bi-plus-circle me-1"></i>
            {{ t("btn_upload_file") }}
          </button>
        </form>

      </div>
    </div>

    <!-- Projektbilder -->
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="h6 mb-0 d-flex align-items-center">
          <i class="bi bi-image me-2"></i>
          {{ t("images_header") }}
        </h3>
      </div>
      <div class="card-body">
        {% if order.images %}
          <ul class="list-group mb-3">
            {% for img in order.images %}
              <li class="list-group-item">
                <div class="d-flex flex-wrap align-items-start justify-content-between gap-3">
                  <div class="d-flex gap-3 align-items-start">
                    <div class="flex-shrink-0">
                      <img
                        src="{{ url_for('order_image_thumbnail', order_id=order.id, image_id=img.id) }}"
                        alt="{{ img.original_name }}"
                        class="img-thumbnail"
                        style="max-width: 200px; height: auto;"
                        loading="lazy"
                      >
                    </div>
                    <div>
                      <strong>{{ img.original_name }}</strong>
                      <small class="text-muted d-block">
                        {% set parts = [] %}
                        {% if img.filesize %}{% set _ = parts.append(((img.filesize / 1024)|round(1)) ~ " KB") %}{% endif %}
                        {% if img.uploaded_at %}{% set _ = parts.append("uploaded " ~ img.uploaded_at.strftime("%Y-%m-%d %H:%M")) %}{% endif %}
                        {% if img.note %}{% set _ = parts.append(img.note) %}{% endif %}
                        {{ " | ".join(parts) }}
                      </small>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            data-bs-toggle="modal"
                            data-bs-target="#imageEditModal"
                            data-image-id="{{ img.id }}"
                            data-image-name="{{ img.original_name }}"
                            data-image-note="{{ img.note or '' }}">
                      <i class="bi bi-pencil me-1"></i>{{ t("btn_edit") }}
                    </button>
                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_order_image', order_id=order.id, image_id=img.id) }}">
                      <i class="bi bi-download me-1"></i>{{ t("btn_download") }}
                    </a>
                    <form method="post" onsubmit="return confirm('{{ t('confirm_delete_image') }}');">
                      <input type="hidden" name="action" value="delete_image">
                      <input type="hidden" name="image_id" value="{{ img.id }}">
                      <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="bi bi-trash me-1"></i>{{ t("btn_delete") }}
                      </button>
                    </form>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted">{{ t("images_none") }}</p>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="mt-2">
          <input type="hidden" name="action" value="upload_image">
          <div class="mb-2">
            <label for="image_file" class="form-label">
              <i class="bi bi-upload me-1"></i>
              {{ t("images_upload_label") }}
            </label>
            <input class="form-control"
                   type="file"
                   id="image_file"
                   name="image_file"
                   accept=".png,.jpg,.jpeg,.gif,.webp">
          </div>
          <div class="row g-2 mb-2">
            <div class="col-md-8">
              <label for="image_note" class="form-label">{{ t("images_label_note") }}</label>
              <input
                type="text"
                class="form-control"
                id="image_note"
                name="image_note"
                maxlength="255"
                placeholder="{{ t('images_note_placeholder') }}"
              >
            </div>
          </div>
          <button type="submit" class="btn btn-secondary btn-sm">
            <i class="bi bi-plus-circle me-1"></i>
            {{ t("btn_upload_file") }}
          </button>
        </form>
      </div>
    </div>

  </div>

  <div class="tab-pane fade" id="print-jobs-tab-pane" role="tabpanel" aria-labelledby="print-jobs-tab">
    <div class="card mb-3">
      <div class="card-header">
        <h3 class="h6 mb-0 d-flex align-items-center">
          <i class="bi bi-printer me-2"></i>
          {{ t("print_jobs_header") }}
        </h3>
      </div>
      <div class="card-body">
        {% if print_jobs %}
          <div class="table-responsive">
            <table class="table table-striped align-middle">
              <thead>
                <tr>
                  <th style="width: 24%;">{{ t("print_jobs_table_file") }}</th>
                  <th style="width: 12%;">{{ t("print_jobs_table_status") }}</th>
                  <th style="width: 16%;">{{ t("print_jobs_table_started_at") }}</th>
                  <th style="width: 12%;">{{ t("print_jobs_table_duration") }}</th>
                  <th style="width: 14%;">{{ t("print_jobs_table_filament") }}</th>
                  <th>{{ t("print_jobs_table_note") }}</th>
                  <th class="text-end" style="width: 16%;">{{ t("table_actions") }}</th>
                </tr>
              </thead>
              <tbody>
                {% for job in print_jobs %}
                  {% set status_value = job.status or '' %}
                  {% set status_label = print_job_status_labels.get(status_value, status_value) %}
                  {% set status_style = print_job_status_styles.get(status_value, "bg-secondary") %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ job.original_name }}</div>
                      <div class="text-muted small">
                        {% set parts = [] %}
                        {% if job.filesize %}{% set _ = parts.append(((job.filesize / 1024)|round(1)) ~ " KB") %}{% endif %}
                        {% if job.uploaded_at %}{% set _ = parts.append(job.uploaded_at.strftime("%Y-%m-%d %H:%M")) %}{% endif %}
                        {{ " | ".join(parts) }}
                      </div>
                    </td>
                    <td>
                      <span class="badge {{ status_style }}">{{ status_label }}</span>
                    </td>
                    <td>
                      {{ job.started_at.strftime("%Y-%m-%d %H:%M") if job.started_at else "-" }}
                    </td>
                    <td>
                      {% if job.duration_min is not none %}
                        {{ job.duration_min }} {{ t("print_jobs_unit_minutes") }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>
                      {% if order.filament_material %}
                        {{ order.filament_material.name }}
                      {% else %}
                        -
                      {% endif %}
                    </td>
                    <td>{{ job.note or "" }}</td>
                    <td class="text-end">
                      {% if current_user.role == 'admin' %}
                        <button type="button"
                                class="btn btn-sm btn-outline-secondary"
                                data-bs-toggle="modal"
                                data-bs-target="#printJobEditModal"
                                data-job-id="{{ job.id }}"
                                data-job-status="{{ status_value }}"
                                data-job-started-at="{{ job.started_at.strftime('%Y-%m-%dT%H:%M') if job.started_at else '' }}"
                                data-job-duration="{{ job.duration_min if job.duration_min is not none else '' }}"
                                data-job-filament-m="{{ job.filament_m if job.filament_m is not none else '' }}"
                                data-job-filament-g="{{ job.filament_g if job.filament_g is not none else '' }}"
                                data-job-note="{{ job.note or '' }}"
                                data-job-filename="{{ job.original_name }}">
                          <i class="bi bi-pencil me-1"></i>{{ t("btn_edit") }}
                        </button>
                      {% endif %}
                      <a class="btn btn-sm btn-outline-primary"
                         href="{{ url_for('download_print_job', order_id=order.id, job_id=job.id) }}">
                        <i class="bi bi-download me-1"></i>{{ t("btn_download") }}
                      </a>
                      {% if current_user.role == 'admin' %}
                        <form method="post" class="d-inline"
                              onsubmit="return confirm('{{ t('confirm_delete_print_job') }}');">
                          <input type="hidden" name="action" value="delete_print_job">
                          <input type="hidden" name="print_job_id" value="{{ job.id }}">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash me-1"></i>{{ t("btn_delete") }}
                          </button>
                        </form>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted">{{ t("print_jobs_none") }}</p>
        {% endif %}
      </div>
    </div>

    {% if current_user.role == 'admin' %}
      <div class="card">
        <div class="card-header">
          <h4 class="h6 mb-0 d-flex align-items-center">
            <i class="bi bi-upload me-2"></i>
            {{ t("print_jobs_upload_title") }}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="action" value="upload_print_job">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="gcode_file" class="form-label">{{ t("print_jobs_label_file") }}</label>
                <input class="form-control"
                       type="file"
                       id="gcode_file"
                       name="gcode_file"
                       accept=".gcode,.gco,.gc"
                       required>
                <div class="form-text">{{ t("print_jobs_hint_file") }}</div>
              </div>
              <div class="col-md-6">
                <label for="print_status" class="form-label">{{ t("print_jobs_label_status") }}</label>
                <select id="print_status" name="print_status" class="form-select">
                  {% for value, label in print_job_statuses %}
                    <option value="{{ value }}" {% if value == 'upload' %}selected{% endif %}>
                      {{ label }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="printer_profile_id" class="form-label">{{ t("order_printer_profile_label") }}</label>
                <select id="printer_profile_id" name="printer_profile_id" class="form-select">
                  <option value="">{{ t("select_placeholder") }}</option>
                  {% for profile in printer_profiles %}
                    <option value="{{ profile.id }}"
                            {% if order.printer_profile_id == profile.id %}selected{% endif %}>
                      {{ profile.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="filament_material_id" class="form-label">{{ t("order_filament_material_label") }}</label>
                <select id="filament_material_id" name="filament_material_id" class="form-select">
                  <option value="">{{ t("select_placeholder") }}</option>
                  {% for material in filament_materials %}
                    <option value="{{ material.id }}"
                            {% if order.filament_material_id == material.id %}selected{% endif %}>
                      {{ material.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="print_started_at" class="form-label">{{ t("print_jobs_label_started_at") }}</label>
                <input class="form-control"
                       type="datetime-local"
                       id="print_started_at"
                       name="print_started_at">
              </div>
              <div class="col-md-6">
                <label for="print_duration_min" class="form-label">{{ t("print_jobs_label_duration") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="1"
                       id="print_duration_min"
                       name="print_duration_min">
                <div class="form-text">{{ t("print_jobs_hint_auto") }}</div>
              </div>
              <div class="col-md-6">
                <label for="print_filament_m" class="form-label">{{ t("print_jobs_label_filament_m") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="0.01"
                       id="print_filament_m"
                       name="print_filament_m">
              </div>
              <div class="col-md-6">
                <label for="print_filament_g" class="form-label">{{ t("print_jobs_label_filament_g") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="0.01"
                       id="print_filament_g"
                       name="print_filament_g">
              </div>
              <div class="col-12">
                <label for="gcode_note" class="form-label">{{ t("print_jobs_label_note") }}</label>
                <input class="form-control"
                       type="text"
                       id="gcode_note"
                       name="gcode_note"
                       maxlength="255"
                       placeholder="{{ t('print_jobs_note_placeholder') }}">
              </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">
              <i class="bi bi-plus-circle me-1"></i>
              {{ t("btn_upload_file") }}
            </button>
          </form>
        </div>
      </div>
    {% else %}
      <p class="text-muted">{{ t("print_jobs_admin_only") }}</p>
    {% endif %}
  </div>
</div>

<div class="modal fade" id="fileEditModal" tabindex="-1" aria-labelledby="fileEditLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="fileEditLabel">{{ t("files_edit_title") }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
      </div>
      <div class="modal-body">
        <form method="post">
          <input type="hidden" name="action" value="update_file">
          <input type="hidden" name="file_id" id="edit_file_id" value="">
          <div class="row g-3">
            <div class="col-12">
              <label for="edit_file_name" class="form-label">{{ t("files_preview_filename") }}</label>
              <input class="form-control" type="text" id="edit_file_name" value="" readonly>
            </div>
            <div class="col-md-8">
              <label for="edit_file_note" class="form-label">{{ t("files_label_note") }}</label>
              <input class="form-control"
                     type="text"
                     id="edit_file_note"
                     name="file_note"
                     maxlength="255"
                     placeholder="{{ t('files_note_placeholder') }}">
            </div>
            <div class="col-md-4">
              <label for="edit_file_quantity" class="form-label">{{ t("files_label_quantity") }}</label>
              <input class="form-control"
                     type="number"
                     min="1"
                     step="1"
                     id="edit_file_quantity"
                     name="file_quantity">
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              {{ t("btn_cancel") }}
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i>{{ t("btn_save_changes") }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="imageEditModal" tabindex="-1" aria-labelledby="imageEditLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageEditLabel">{{ t("images_edit_title") }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
      </div>
      <div class="modal-body">
        <form method="post">
          <input type="hidden" name="action" value="update_image">
          <input type="hidden" name="image_id" id="edit_image_id" value="">
          <div class="row g-3">
            <div class="col-12">
              <label for="edit_image_name" class="form-label">{{ t("files_preview_filename") }}</label>
              <input class="form-control" type="text" id="edit_image_name" value="" readonly>
            </div>
            <div class="col-12">
              <label for="edit_image_note" class="form-label">{{ t("images_label_note") }}</label>
              <input class="form-control"
                     type="text"
                     id="edit_image_note"
                     name="image_note"
                     maxlength="255"
                     placeholder="{{ t('images_note_placeholder') }}">
            </div>
          </div>
          <div class="d-flex justify-content-end gap-2 mt-3">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              {{ t("btn_cancel") }}
            </button>
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-save me-1"></i>{{ t("btn_save_changes") }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% if current_user.role == 'admin' %}
  <div class="modal fade" id="printJobEditModal" tabindex="-1" aria-labelledby="printJobEditLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="printJobEditLabel">{{ t("print_jobs_edit_title") }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
        </div>
        <div class="modal-body">
          <form method="post">
            <input type="hidden" name="action" value="update_print_job">
            <input type="hidden" name="print_job_id" id="edit_print_job_id" value="">
            <div class="row g-3">
              <div class="col-12">
                <label for="edit_print_job_file" class="form-label">{{ t("print_jobs_label_file") }}</label>
                <input class="form-control" type="text" id="edit_print_job_file" value="" readonly>
              </div>
              <div class="col-md-6">
                <label for="edit_print_status" class="form-label">{{ t("print_jobs_label_status") }}</label>
                <select id="edit_print_status" name="edit_print_status" class="form-select">
                  {% for value, label in print_job_statuses %}
                    <option value="{{ value }}">{{ label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-6">
                <label for="edit_print_started_at" class="form-label">{{ t("print_jobs_label_started_at") }}</label>
                <input class="form-control"
                       type="datetime-local"
                       id="edit_print_started_at"
                       name="edit_print_started_at">
              </div>
              <div class="col-md-6">
                <label for="edit_print_duration_min" class="form-label">{{ t("print_jobs_label_duration") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="1"
                       id="edit_print_duration_min"
                       name="edit_print_duration_min">
                <div class="form-text">{{ t("print_jobs_hint_auto") }}</div>
              </div>
              <div class="col-md-6">
                <label for="edit_print_filament_m" class="form-label">{{ t("print_jobs_label_filament_m") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="0.01"
                       id="edit_print_filament_m"
                       name="edit_print_filament_m">
              </div>
              <div class="col-md-6">
                <label for="edit_print_filament_g" class="form-label">{{ t("print_jobs_label_filament_g") }}</label>
                <input class="form-control"
                       type="number"
                       min="0"
                       step="0.01"
                       id="edit_print_filament_g"
                       name="edit_print_filament_g">
              </div>
              <div class="col-12">
                <label for="edit_print_note" class="form-label">{{ t("print_jobs_label_note") }}</label>
                <input class="form-control"
                       type="text"
                       id="edit_print_note"
                       name="edit_print_note"
                       maxlength="255">
              </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-3">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                {{ t("btn_cancel") }}
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>{{ t("btn_save_changes") }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endif %}

<!-- 3D Preview Modal -->
<div class="modal fade" id="modelPreviewModal" tabindex="-1" aria-labelledby="modelPreviewLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modelPreviewLabel" data-model-title>{{ t("files_preview_title") }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
      </div>
      <div class="modal-body">
        <div class="model-preview-meta mb-3">
          <div class="row g-3 align-items-start">
            <div class="col-lg-8">
              <div class="text-muted small">{{ t("files_preview_filename") }}</div>
              <div class="fw-semibold" data-model-filename></div>
              <div class="text-muted small mt-2">{{ t("files_preview_note_label") }}</div>
              <div class="text-muted" data-model-note></div>
            </div>
            <div class="col-lg-4">
              <label for="modelColorSelect" class="form-label">
                {{ t("files_color_label") }} <span class="text-muted">({{ t("files_preview_hint") }})</span>
              </label>
              <select id="modelColorSelect" class="form-select" data-model-color-select>
                <option value="">{{ t("files_color_none") }}</option>
                {% for c in colors %}
                  <option value="{{ c.id }}" data-hex="{{ c.hex_code or '' }}">{{ c.name }}</option>
                {% endfor %}
              </select>
              <div class="small text-muted mt-1" data-model-feedback></div>
            </div>
          </div>
        </div>
        <div class="model-preview-wrap">
          <img class="model-preview-poster d-none" data-model-poster alt="{{ t('files_preview_title') }}">
          <div class="model-preview-canvas" data-model-canvas></div>
          <div class="model-preview-status" data-model-status>{{ t("files_preview_loading") }}</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NACHRICHTEN / KOMMUNIKATION -->
<div class="card mb-3">
  <div class="card-header">
    <h3 class="h6 mb-0 d-flex align-items-center">
      <i class="bi bi-chat-dots me-2"></i>
      {{ t("communication_header") }}
    </h3>
  </div>
  <div class="card-body">

  <div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">{{ t("messages_header") }}</h5>
    </div>

    <div id="messagesContainer" class="card-body neo-chat-thread">
        {% include "order_messages_fragment.html" %}
    </div>

    <!-- Chat-Eingabefeld im Footer -->
    <div class="card-footer bg-light">
        <form method="post" class="neo-chat-input">
            <input type="hidden" name="action" value="add_message">
            <div class="input-group">
                <textarea
                    class="form-control"
                    name="content"
                    rows="1"
                    placeholder="{{ t('message_placeholder') }}"
                    required
                ></textarea>
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-send"></i>
                    <span class="d-none d-sm-inline ms-1">{{ t("btn_send") }}</span>
                </button>
            </div>
        </form>
    </div>
  </div>

  


    

  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
function updateColorPreview() {
  const select = document.getElementById("color_id");
  const preview = document.getElementById("colorPreview");

  if (!select || !preview) return;

  const selected = select.options[select.selectedIndex];
  const hex = selected.getAttribute("data-hex");

  if (hex && /^#([0-9A-Fa-f]{6})$/.test(hex)) {
    preview.style.backgroundColor = hex;
    preview.style.border = "1px solid #ccc";
  } else {
    preview.style.backgroundColor = "transparent";
    preview.style.border = "1px solid #ccc";
  }
}

(function() {
  const container = document.getElementById("messagesContainer");
  const fetchUrl = "{{ url_for('order_messages_fragment', order_id=order.id) }}";

  if (!container || !fetchUrl) return;

  async function refreshMessages() {
    try {
      const resp = await fetch(fetchUrl, { headers: { "X-Requested-With": "Fetch" } });
      if (!resp.ok) return;
      const html = await resp.text();
      container.innerHTML = html;
    } catch (err) {
      // still retry on next interval
    }
  }

  refreshMessages();
  setInterval(refreshMessages, 5000);
})();

(function() {
  const editModal = document.getElementById("printJobEditModal");
  if (!editModal) return;

  editModal.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    if (!button) return;

    const jobId = button.getAttribute("data-job-id") || "";
    const status = button.getAttribute("data-job-status") || "upload";
    const startedAt = button.getAttribute("data-job-started-at") || "";
    const duration = button.getAttribute("data-job-duration") || "";
    const filamentM = button.getAttribute("data-job-filament-m") || "";
    const filamentG = button.getAttribute("data-job-filament-g") || "";
    const note = button.getAttribute("data-job-note") || "";
    const filename = button.getAttribute("data-job-filename") || "";

    const idInput = editModal.querySelector("#edit_print_job_id");
    const statusSelect = editModal.querySelector("#edit_print_status");
    const startedInput = editModal.querySelector("#edit_print_started_at");
    const durationInput = editModal.querySelector("#edit_print_duration_min");
    const filamentMInput = editModal.querySelector("#edit_print_filament_m");
    const filamentGInput = editModal.querySelector("#edit_print_filament_g");
    const noteInput = editModal.querySelector("#edit_print_note");
    const fileInput = editModal.querySelector("#edit_print_job_file");

    if (idInput) idInput.value = jobId;
    if (statusSelect) statusSelect.value = status;
    if (startedInput) startedInput.value = startedAt;
    if (durationInput) durationInput.value = duration;
    if (filamentMInput) filamentMInput.value = filamentM;
    if (filamentGInput) filamentGInput.value = filamentG;
    if (noteInput) noteInput.value = note;
    if (fileInput) fileInput.value = filename;
  });
})();

(function() {
  const fileEditModal = document.getElementById("fileEditModal");
  if (!fileEditModal) return;

  fileEditModal.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    if (!button) return;

    const fileId = button.getAttribute("data-file-id") || "";
    const fileName = button.getAttribute("data-file-name") || "";
    const fileNote = button.getAttribute("data-file-note") || "";
    const fileQuantity = button.getAttribute("data-file-quantity") || "1";

    const idInput = fileEditModal.querySelector("#edit_file_id");
    const nameInput = fileEditModal.querySelector("#edit_file_name");
    const noteInput = fileEditModal.querySelector("#edit_file_note");
    const quantityInput = fileEditModal.querySelector("#edit_file_quantity");

    if (idInput) idInput.value = fileId;
    if (nameInput) nameInput.value = fileName;
    if (noteInput) noteInput.value = fileNote;
    if (quantityInput) quantityInput.value = fileQuantity;
  });
})();

(function() {
  const imageEditModal = document.getElementById("imageEditModal");
  if (!imageEditModal) return;

  imageEditModal.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    if (!button) return;

    const imageId = button.getAttribute("data-image-id") || "";
    const imageName = button.getAttribute("data-image-name") || "";
    const imageNote = button.getAttribute("data-image-note") || "";

    const idInput = imageEditModal.querySelector("#edit_image_id");
    const nameInput = imageEditModal.querySelector("#edit_image_name");
    const noteInput = imageEditModal.querySelector("#edit_image_note");

    if (idInput) idInput.value = imageId;
    if (nameInput) nameInput.value = imageName;
    if (noteInput) noteInput.value = imageNote;
  });
})();
</script>
<script type="module">
import * as THREE from "three";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";
import { STLLoader } from "three/addons/loaders/STLLoader.js";
import { ThreeMFLoader } from "three/addons/loaders/3MFLoader.js";

const modalEl = document.getElementById("modelPreviewModal");
const previewButtons = document.querySelectorAll("[data-model-preview='true']");

if (modalEl && previewButtons.length) {
  const titleEl = modalEl.querySelector("[data-model-title]");
  const posterEl = modalEl.querySelector("[data-model-poster]");
  const statusEl = modalEl.querySelector("[data-model-status]");
  const canvasWrap = modalEl.querySelector("[data-model-canvas]");
  const filenameEl = modalEl.querySelector("[data-model-filename]");
  const noteEl = modalEl.querySelector("[data-model-note]");
  const colorSelect = modalEl.querySelector("[data-model-color-select]");
  const feedbackEl = modalEl.querySelector("[data-model-feedback]");
  const baseTitle = titleEl ? titleEl.textContent : "";

  const labels = {
    loading: "{{ t('files_preview_loading') }}",
    failed: "{{ t('files_preview_failed') }}",
    unavailable: "{{ t('files_preview_unavailable') }}",
    noteEmpty: "{{ t('files_preview_note_empty') }}",
    saving: "{{ t('files_color_saving') }}",
    saved: "{{ t('files_color_saved') }}",
    saveFailed: "{{ t('files_color_save_failed') }}",
    thumbnailUpdated: "{{ t('files_thumbnail_updated') }}",
    thumbnailFailed: "{{ t('files_thumbnail_failed') }}"
  };

  const defaultColorHex = "#6fa8dc";
  const thumbnailZoom = 2;
  let renderer = null;
  let scene = null;
  let camera = null;
  let controls = null;
  let currentObject = null;
  let currentButton = null;
  let currentFileId = null;
  let currentOrderId = null;
  let currentThumbSmUrl = "";
  let currentThumbLgUrl = "";
  let currentColorHex = defaultColorHex;
  let colorSaveTimer = null;
  let modelReady = false;
  let animationId = null;
  let resizeObserver = null;

  function setStatus(text) {
    if (!statusEl) return;
    if (text) {
      statusEl.textContent = text;
      statusEl.classList.remove("d-none");
    } else {
      statusEl.classList.add("d-none");
    }
  }

  function setPoster(url) {
    if (!posterEl) return;
    if (url) {
      posterEl.src = url;
      posterEl.classList.remove("d-none");
    } else {
      posterEl.classList.add("d-none");
      posterEl.removeAttribute("src");
    }
  }

  function setFeedback(text) {
    if (!feedbackEl) return;
    feedbackEl.textContent = text || "";
  }

  function getSelectedColorHex() {
    if (!colorSelect) return "";
    const selected = colorSelect.options[colorSelect.selectedIndex];
    if (!selected) return "";
    const hex = selected.getAttribute("data-hex") || "";
    if (/^#([0-9A-Fa-f]{6})$/.test(hex)) {
      return hex;
    }
    return "";
  }

  function applyColorToObject(hexColor) {
    if (!currentObject) return;
    const color = new THREE.Color(hexColor || defaultColorHex);
    currentObject.traverse((child) => {
      if (!child.isMesh || !child.material) return;
      if (Array.isArray(child.material)) {
        child.material.forEach((mat) => {
          if (mat.color) {
            mat.color.set(color);
            mat.needsUpdate = true;
          }
        });
      } else if (child.material.color) {
        child.material.color.set(color);
        child.material.needsUpdate = true;
      }
    });
  }

  function bustUrl(url) {
    if (!url) return "";
    const sep = url.includes("?") ? "&" : "?";
    return `${url}${sep}v=${Date.now()}`;
  }

  function updateThumbnailImages() {
    if (!currentButton) return;
    const img = currentButton.querySelector(".model-thumb-img");
    if (img && currentThumbSmUrl) {
      img.classList.remove("d-none");
      const placeholder = currentButton.querySelector(".model-thumb-placeholder");
      if (placeholder) {
        placeholder.classList.add("d-none");
      }
      img.src = bustUrl(currentThumbSmUrl);
    }
    if (currentThumbLgUrl) {
      const posterUrl = bustUrl(currentThumbLgUrl);
      currentButton.setAttribute("data-preview-poster", posterUrl);
      setPoster(posterUrl);
    }
  }

  async function uploadThumbnail() {
    if (!renderer || !scene || !camera || !currentOrderId || !currentFileId || !modelReady) {
      return null;
    }
    const originalZoom = camera.zoom;
    try {
      camera.zoom = thumbnailZoom;
      camera.updateProjectionMatrix();
      if (controls) {
        controls.update();
      }
      renderer.render(scene, camera);
      const dataUrl = renderer.domElement.toDataURL("image/png");
      const resp = await fetch(`/orders/${currentOrderId}/files/${currentFileId}/thumbnail/lg`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "Fetch"
        },
        body: JSON.stringify({ data_url: dataUrl })
      });
      if (!resp.ok) {
        return false;
      }
      const payload = await resp.json();
      if (!payload || !payload.ok) {
        return false;
      }
      updateThumbnailImages();
      return true;
    } catch (err) {
      return false;
    } finally {
      camera.zoom = originalZoom;
      camera.updateProjectionMatrix();
      if (controls) {
        controls.update();
      }
    }
  }

  async function saveColorSelection() {
    if (!currentFileId) return;
    const colorId = colorSelect ? colorSelect.value : "";
    try {
      const resp = await fetch(`/files/${currentFileId}/set-color`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-Requested-With": "Fetch"
        },
        body: JSON.stringify({ color_id: colorId || null })
      });
      if (!resp.ok) {
        throw new Error("save failed");
      }
      const payload = await resp.json();
      if (!payload || !payload.ok) {
        throw new Error("save failed");
      }
      if (currentButton) {
        currentButton.setAttribute("data-preview-color-id", colorId || "");
      }
      setFeedback(labels.saved);
      const thumbOk = await uploadThumbnail();
      if (thumbOk === true) {
        setFeedback(`${labels.saved}  ${labels.thumbnailUpdated}`);
      } else if (thumbOk === false) {
        setFeedback(`${labels.saved}  ${labels.thumbnailFailed}`);
      } else {
        setFeedback(labels.saved);
      }
    } catch (err) {
      setFeedback(labels.saveFailed);
    }
  }

  function scheduleColorSave() {
    if (!currentFileId) return;
    setFeedback(labels.saving);
    if (colorSaveTimer) {
      clearTimeout(colorSaveTimer);
    }
    colorSaveTimer = setTimeout(saveColorSelection, 450);
  }

  function disposeObject(obj) {
    obj.traverse((child) => {
      if (child.geometry) {
        child.geometry.dispose();
      }
      if (child.material) {
        if (Array.isArray(child.material)) {
          child.material.forEach((mat) => mat.dispose && mat.dispose());
        } else if (child.material.dispose) {
          child.material.dispose();
        }
      }
    });
  }

  function clearScene() {
    if (scene && currentObject) {
      scene.remove(currentObject);
      disposeObject(currentObject);
      currentObject = null;
    }
  }

  function updateRendererSize() {
    if (!renderer || !camera || !canvasWrap) return;
    const width = canvasWrap.clientWidth || 0;
    const height = canvasWrap.clientHeight || 0;
    if (!width || !height) return;
    renderer.setSize(width, height, false);
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
  }

  function startRender() {
    if (animationId || !renderer || !scene || !camera) return;
    const renderLoop = () => {
      animationId = requestAnimationFrame(renderLoop);
      if (controls) {
        controls.update();
      }
      renderer.render(scene, camera);
    };
    renderLoop();
  }

  function stopRender() {
    if (animationId) {
      cancelAnimationFrame(animationId);
      animationId = null;
    }
  }

  function initViewer() {
    if (!canvasWrap || renderer) return;
    scene = new THREE.Scene();
    try {
      renderer = new THREE.WebGLRenderer({ antialias: true });
    } catch (err) {
      setStatus(labels.unavailable);
      return;
    }
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setClearColor(0xf8f9fa, 1);
    canvasWrap.appendChild(renderer.domElement);

    camera = new THREE.PerspectiveCamera(45, 1, 0.1, 10000);
    controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    const hemi = new THREE.HemisphereLight(0xffffff, 0x7a7a7a, 1.0);
    const dir = new THREE.DirectionalLight(0xffffff, 0.9);
    dir.position.set(2, 2, 2);
    scene.add(hemi, dir);

    if ("ResizeObserver" in window) {
      resizeObserver = new ResizeObserver(updateRendererSize);
      resizeObserver.observe(canvasWrap);
    } else {
      window.addEventListener("resize", updateRendererSize);
    }
    updateRendererSize();
  }

  function frameObject(object) {
    if (!camera || !controls) return;
    const box = new THREE.Box3().setFromObject(object);
    const size = box.getSize(new THREE.Vector3());
    const center = box.getCenter(new THREE.Vector3());
    object.position.sub(center);

    const maxDim = Math.max(size.x, size.y, size.z);
    if (maxDim <= 0) return;
    const fov = (camera.fov * Math.PI) / 180;
    const fitDistance = (maxDim / 2) / Math.tan(fov / 2);
    const distance = fitDistance * 1.1;
    camera.position.set(distance, distance, distance);
    camera.near = Math.max(distance / 100, 0.01);
    camera.far = distance * 100;
    camera.updateProjectionMatrix();
    controls.target.set(0, 0, 0);
    controls.update();
  }

  function loadModel(url, type) {
    if (!url) {
      setStatus(labels.unavailable);
      return;
    }

    initViewer();
    if (!renderer || !scene || !camera) {
      setStatus(labels.unavailable);
      return;
    }
    clearScene();
    modelReady = false;
    setStatus(labels.loading);

    const fileType = (type || "stl").toLowerCase();
    if (fileType === "3mf") {
      const loader = new ThreeMFLoader();
      loader.load(
        url,
        (object) => {
          currentObject = object;
          scene.add(object);
          frameObject(object);
          applyColorToObject(currentColorHex);
          setStatus("");
          setPoster("");
          modelReady = true;
          startRender();
        },
        undefined,
        () => {
          setStatus(labels.failed);
        }
      );
      return;
    }

    const loader = new STLLoader();
    loader.load(
      url,
      (geometry) => {
        geometry.computeVertexNormals();
        const material = new THREE.MeshStandardMaterial({
          color: currentColorHex || defaultColorHex,
          metalness: 0.1,
          roughness: 0.6
        });
        const mesh = new THREE.Mesh(geometry, material);
        currentObject = mesh;
        scene.add(mesh);
        frameObject(mesh);
        applyColorToObject(currentColorHex);
        setStatus("");
        setPoster("");
        modelReady = true;
        startRender();
      },
      undefined,
      () => {
        setStatus(labels.failed);
      }
    );
  }

  previewButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      currentButton = btn;
      const url = btn.getAttribute("data-preview-url") || "";
      const name = btn.getAttribute("data-preview-name") || "";
      const type = btn.getAttribute("data-preview-type") || "stl";
      const poster = btn.getAttribute("data-preview-poster") || "";
      const note = btn.getAttribute("data-preview-note") || "";
      const colorId = btn.getAttribute("data-preview-color-id") || "";
      currentFileId = btn.getAttribute("data-preview-file-id") || "";
      currentOrderId = btn.getAttribute("data-preview-order-id") || "";
      currentThumbSmUrl = btn.getAttribute("data-preview-thumb-sm") || "";
      currentThumbLgUrl = btn.getAttribute("data-preview-thumb-lg") || "";

      if (titleEl) {
        titleEl.textContent = name ? name : baseTitle;
      }
      if (filenameEl) {
        filenameEl.textContent = name ? name : baseTitle;
      }
      if (noteEl) {
        noteEl.textContent = note ? note : labels.noteEmpty;
      }
      if (colorSelect) {
        colorSelect.value = colorId;
        currentColorHex = getSelectedColorHex() || defaultColorHex;
      } else {
        currentColorHex = defaultColorHex;
      }
      setFeedback("");
      setPoster(poster);
      setStatus(labels.loading);

      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

      loadModel(url, type);
    });
  });

  if (colorSelect) {
    colorSelect.addEventListener("change", () => {
      currentColorHex = getSelectedColorHex() || defaultColorHex;
      applyColorToObject(currentColorHex);
      scheduleColorSave();
    });
  }

  modalEl.addEventListener("hidden.bs.modal", () => {
    stopRender();
    clearScene();
    setPoster("");
    setStatus("");
    setFeedback("");
    modelReady = false;
    currentButton = null;
    currentFileId = null;
    currentOrderId = null;
    currentThumbSmUrl = "";
    currentThumbLgUrl = "";
    currentColorHex = defaultColorHex;
    if (colorSelect) {
      colorSelect.value = "";
    }
    if (noteEl) {
      noteEl.textContent = "";
    }
    if (filenameEl) {
      filenameEl.textContent = "";
    }
    if (colorSaveTimer) {
      clearTimeout(colorSaveTimer);
      colorSaveTimer = null;
    }
    if (titleEl) {
      titleEl.textContent = baseTitle;
    }
  });
}
</script>
{% endblock %}
