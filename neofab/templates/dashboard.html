{# templates/dashboard.html #}
{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Dashboard</h1>

    <!-- Button: New order -->
    <a href="{{ url_for('new_order') }}" class="btn btn-primary">
        New order
    </a>
</div>

<hr>

<h2 class="mt-4">
    {% if current_user.role == 'admin' %}
        Orders (all)
    {% else %}
        My orders
    {% endif %}
</h2>

{% if orders %}
    <table class="table table-striped mt-3">
        <thead>
            <tr>
                <th>#</th>
                <th>Title</th>
                <th>Status</th>
                <th>Created at</th>
                <th>Last new message</th>
                {% if current_user.role == 'admin' %}
                    <th>Owner</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for o in orders %}
            <tr>
                <td>{{ o.id }}</td>
                <td>
                    <a href="{{ url_for('order_detail', order_id=o.id) }}">
                        {{ o.title }}
                    </a>
                </td>
                <td>
                    {{ status_labels.get(o.status, o.status) }}
                </td>
                <td>
                    {% if o.created_at %}
                        {{ o.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% endif %}
                </td>
                <td>
                    {% set dt = last_new_message.get(o.id) %}
                    {% if dt %}
                        {{ dt.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        No new message
                    {% endif %}
                </td>
                {% if current_user.role == 'admin' %}
                    <td>
                        {% if o.user %}
                            {{ o.user.first_name or '' }} {{ o.user.last_name or '' }}<br>
                            <small class="text-muted">{{ o.user.email }}</small>
                        {% endif %}
                    </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

{% else %}
    <p class="mt-3 text-muted">
        {% if current_user.role == 'admin' %}
            There are currently no orders.
        {% else %}
            You have not created any orders yet.
        {% endif %}
    </p>
{% endif %}

{% endblock %}
