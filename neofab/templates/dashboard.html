{% extends "base.html" %}

{% block title %}Dashboard – NeoFab{% endblock %}

{% block content %}

<div class="card">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h2 class="h5 mb-0">
      {{ t("orders") }}
    </h2>

    <div class="d-flex flex-wrap gap-2">
      <!-- Neuer Auftrag -->
      <a href="{{ url_for('new_order') }}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-circle me-1"></i>
        {{ t("new_order") }}
      </a>
    </div>
  </div>

  <div class="card-body p-2">
    {% if orders %}
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm align-middle mb-0">
          <thead>
            <tr>
              <th>ID</th>
              <th>{{ t("title") }}</th>
              <th>{{ t("status") }}</th>
              <th>{{ t("owner") }}</th>
              <th>{{ t("created") }}</th>
              <th class="text-center">{{ t("files") }}</th>
              <th class="text-center">{{ t("print_jobs_header") }}</th>
              <th class="text-end">{{ t("actions") }}</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr>
              <td>{{ o.id }}</td>

              <td>
                <a href="{{ url_for('order_detail', order_id=o.id) }}">
                  {{ o.title }}
                </a>
                {% if last_new_message.get(o.id) %}
                  <span class="badge bg-warning text-dark ms-1">{{ t("new_message") }}</span>
                {% endif %}
              </td>

              <td>
                {% set status_style = status_styles.get(o.status, "bg-light text-dark") %}
                <span class="badge {{ status_style }}">
                  {{ status_labels.get(o.status, o.status) }}
                </span>
              </td>

              <td>{{ o.user.email }}</td>

              <td>{{ o.created_at.strftime('%Y-%m-%d %H:%M') if o.created_at else '' }}</td>

              <td class="text-center">
                {{ file_counts.get(o.id, 0) }}
              </td>

              <td class="text-center">
                {{ print_job_counts.get(o.id, 0) }}
              </td>

              <td class="text-end">
                <a href="{{ url_for('order_detail', order_id=o.id) }}"
                   class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-pencil-square me-1"></i>
                  {{ t("details") }}
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-0">{{ t("no_orders") }}</p>
    {% endif %}
  </div>
</div>

<div class="card mt-3">
  <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
    <h3 class="h6 mb-0 d-flex align-items-center">
      <i class="bi bi-megaphone me-2"></i>
      {{ t("announcements_header") }}
    </h3>
    {% if current_user.role == 'admin' %}
      <button type="button"
              class="btn btn-outline-secondary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#announcementModal"
              data-mode="create">
        <i class="bi bi-plus-circle me-1"></i>
        {{ t("btn_announcements") }}
      </button>
    {% endif %}
  </div>
  <div class="card-body">
    {% if announcements_unread %}
      <div class="list-group">
        {% for a in announcements_unread %}
          {% set meta = announcement_priority_meta.get(a.priority, announcement_priority_meta.get("info")) %}
          <div class="list-group-item">
            <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
              <div>
                <div class="fw-semibold">
                  <i class="bi {{ meta["icon"] }} {{ meta["class"] }} me-1"></i>
                  {{ a.title }}
                </div>
                <div class="text-muted small">
                  {{ t(meta["label"]) }}{% if a.created_at %} · {{ a.created_at.strftime("%Y-%m-%d %H:%M") }}{% endif %}
                </div>
              </div>
              <div class="d-flex gap-2">
                {% if current_user.role == 'admin' %}
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-bs-toggle="modal"
                          data-bs-target="#announcementModal"
                          data-mode="edit"
                          data-announcement-id="{{ a.id }}"
                          data-announcement-title="{{ a.title|e }}"
                          data-announcement-body="{{ a.body|e }}"
                          data-announcement-priority="{{ a.priority }}">
                    <i class="bi bi-pencil me-1"></i>{{ t("btn_edit") }}
                  </button>
                {% endif %}
              </div>
            </div>
            <div class="mt-2">
              {{ a.body }}
            </div>
            <div class="d-flex justify-content-end mt-3">
              <form method="post">
                <input type="hidden" name="action" value="mark_announcement_read">
                <input type="hidden" name="announcement_id" value="{{ a.id }}">
                <button type="submit" class="btn btn-sm btn-outline-success">
                  <i class="bi bi-check2-circle me-1"></i>{{ t("btn_mark_read") }}
                </button>
              </form>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="mb-0 text-muted">{{ t("announcements_none") }}</p>
    {% endif %}
  </div>
</div>

{% if current_user.role == 'admin' %}
  <div class="modal fade" id="announcementModal" tabindex="-1" aria-labelledby="announcementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="announcementModalLabel">{{ t("announcements_modal_create_title") }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{{ t('btn_cancel') }}"></button>
        </div>
        <div class="modal-body">
          <form method="post">
            <input type="hidden" name="action" id="announcement_action" value="create_announcement">
            <input type="hidden" name="announcement_id" id="announcement_id" value="">
            <div class="mb-3">
              <label for="announcement_title" class="form-label">{{ t("announcement_title_label") }}</label>
              <input class="form-control"
                     type="text"
                     id="announcement_title"
                     name="announcement_title"
                     maxlength="200"
                     required>
            </div>
            <div class="mb-3">
              <label for="announcement_priority" class="form-label">{{ t("announcement_priority_label") }}</label>
              <select id="announcement_priority" name="announcement_priority" class="form-select">
                <option value="info">{{ t("announcement_priority_info") }}</option>
                <option value="notice">{{ t("announcement_priority_notice") }}</option>
                <option value="important">{{ t("announcement_priority_important") }}</option>
                <option value="warning">{{ t("announcement_priority_warning") }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="announcement_body" class="form-label">{{ t("announcement_body_label") }}</label>
              <textarea class="form-control"
                        id="announcement_body"
                        name="announcement_body"
                        rows="4"
                        required></textarea>
            </div>
            <div class="d-flex justify-content-end gap-2">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                {{ t("btn_cancel") }}
              </button>
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save me-1"></i>{{ t("btn_save_changes") }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endif %}

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
  const modalEl = document.getElementById("announcementModal");
  if (!modalEl) return;

  const labels = {
    create: "{{ t('announcements_modal_create_title') }}",
    edit: "{{ t('announcements_modal_edit_title') }}"
  };

  modalEl.addEventListener("show.bs.modal", (event) => {
    const button = event.relatedTarget;
    if (!button) return;

    const mode = button.getAttribute("data-mode") || "create";
    const id = button.getAttribute("data-announcement-id") || "";
    const title = button.getAttribute("data-announcement-title") || "";
    const body = button.getAttribute("data-announcement-body") || "";
    const priority = button.getAttribute("data-announcement-priority") || "info";

    const actionInput = modalEl.querySelector("#announcement_action");
    const idInput = modalEl.querySelector("#announcement_id");
    const titleInput = modalEl.querySelector("#announcement_title");
    const bodyInput = modalEl.querySelector("#announcement_body");
    const priorityInput = modalEl.querySelector("#announcement_priority");
    const titleEl = modalEl.querySelector(".modal-title");

    if (actionInput) {
      actionInput.value = mode === "edit" ? "update_announcement" : "create_announcement";
    }
    if (idInput) idInput.value = mode === "edit" ? id : "";
    if (titleInput) titleInput.value = mode === "edit" ? title : "";
    if (bodyInput) bodyInput.value = mode === "edit" ? body : "";
    if (priorityInput) priorityInput.value = priority;
    if (titleEl) titleEl.textContent = labels[mode] || labels.create;
  });
})();
</script>
{% endblock %}
