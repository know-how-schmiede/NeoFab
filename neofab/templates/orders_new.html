{% extends "base.html" %}

{% block title %}New Order – NeoFab{% endblock %}

{% block content %}

<div class="card mb-3">
  <div class="card-header">
    <h2 class="h5 mb-0">
      <i class="bi bi-plus-circle me-1"></i>
      New Order
    </h2>
  </div>

  <div class="card-body">
    <form method="post" enctype="multipart/form-data">

      <div class="row g-3">

        <!-- Title -->
        <div class="col-12">
          <label for="title" class="form-label">
            <i class="bi bi-card-text me-1"></i>
            Title*
          </label>
          <input
            type="text"
            class="form-control"
            id="title"
            name="title"
            required
          >
        </div>

        <!-- Description -->
        <div class="col-12">
          <label for="description" class="form-label">
            <i class="bi bi-journal-text me-1"></i>
            Description
          </label>
          <textarea
            class="form-control"
            id="description"
            name="description"
            rows="4"
          ></textarea>
        </div>

        <!-- Cost Center -->
        <div class="col-md-6">
          <label for="cost_center_id" class="form-label">
            <i class="bi bi-bank me-1"></i>
            Cost Center
          </label>
          <select
            id="cost_center_id"
            name="cost_center_id"
            class="form-select"
          >
            <option value="">– Please select –</option>
            {% for cc in cost_centers %}
              <option value="{{ cc.id }}">{{ cc.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Material -->
        <div class="col-md-6">
          <label for="material_id" class="form-label">
            <i class="bi bi-box-seam me-1"></i>
            Material
          </label>
          <select
            id="material_id"
            name="material_id"
            class="form-select"
          >
            <option value="">– Please select –</option>
            {% for m in materials %}
              <option value="{{ m.id }}">{{ m.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Color mit Vorschau -->
        <div class="col-md-6">
          <label for="color_id" class="form-label">
            <i class="bi bi-palette me-1"></i>
            Color
          </label>
          <div class="input-group">
            <select
              id="color_id"
              name="color_id"
              class="form-select"
              onchange="updateColorPreview()"
            >
              <option value="">– Please select –</option>
              {% for c in colors %}
                <option value="{{ c.id }}"
                        data-hex="{{ c.hex_code if c.hex_code else '' }}">
                  {{ c.name }}{% if c.hex_code %} ({{ c.hex_code }}){% endif %}
                </option>
              {% endfor %}
            </select>
            <span class="input-group-text p-0">
              <div id="colorPreview"
                   style="width: 32px; height: 32px; border-radius: 4px;
                          border: 1px solid #ccc; background-color: transparent;">
              </div>
            </span>
          </div>
        </div>

        {% if current_user.role == 'admin' %}
        <!-- Status (nur Admin) -->
        <div class="col-md-6">
          <label for="status" class="form-label">
            <i class="bi bi-flag me-1"></i>
            Status
          </label>
          <select
            id="status"
            name="status"
            class="form-select"
          >
            {% for value, label in order_statuses %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

      </div>

      <div class="mb-3">
        <label for="model_file" class="form-label">
            3D-Modell hochladen (STL oder 3MF)
        </label>
        <input class="form-control"
               type="file"
               id="model_file"
               name="model_file"
               accept=".stl,.3mf">
        <div class="form-text">
            Erlaubte Formate: .stl, .3mf
        </div>
    </div>

      <!-- Buttons -->
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>
          Create Order
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          Back to dashboard
        </a>
      </div>

    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateColorPreview() {
  const select = document.getElementById("color_id");
  const preview = document.getElementById("colorPreview");

  if (!select || !preview) return;

  const selected = select.options[select.selectedIndex];
  const hex = selected.getAttribute("data-hex");

  if (hex && /^#([0-9A-Fa-f]{6})$/.test(hex)) {
    preview.style.backgroundColor = hex;
    preview.style.border = "1px solid #ccc";
  } else {
    preview.style.backgroundColor = "transparent";
    preview.style.border = "1px solid #ccc";
  }
}
</script>
{% endblock %}
