{% extends "base.html" %}

{% block title %}New Order – NeoFab{% endblock %}

{% block content %}

<div class="card mb-3">
  <div class="card-header">
    <h2 class="h5 mb-0">
      <i class="bi bi-plus-circle me-1"></i>
      New Order
    </h2>
  </div>

  <div class="card-body">
    <form method="post" enctype="multipart/form-data">

      <div class="row g-3">

        <!-- Title -->
        <div class="col-12">
          <label for="title" class="form-label">
            <i class="bi bi-card-text me-1"></i>
            Title*
          </label>
          <input
            type="text"
            class="form-control"
            id="title"
            name="title"
            required
          >
        </div>

        <!-- Description -->
        <div class="col-12">
          <label for="description" class="form-label">
            <i class="bi bi-journal-text me-1"></i>
            Description
          </label>
          <textarea
            class="form-control"
            id="description"
            name="description"
            rows="4"
          ></textarea>
        </div>

        <!-- Cost Center -->
        <div class="col-md-6">
          <label for="cost_center_id" class="form-label">
            <i class="bi bi-bank me-1"></i>
            Cost Center
          </label>
          <select
            id="cost_center_id"
            name="cost_center_id"
            class="form-select"
          >
            <option value="">– Please select –</option>
            {% for cc in cost_centers %}
              <option value="{{ cc.id }}">{{ cc.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Öffentlichkeitsfreigaben -->
        <div class="col-md-6">
          <label class="form-label d-block">
            <i class="bi bi-megaphone me-1"></i>
            Public Sharing
          </label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="public_allow_poster" name="public_allow_poster">
            <label class="form-check-label" for="public_allow_poster">Allow poster display</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="public_allow_web" name="public_allow_web">
            <label class="form-check-label" for="public_allow_web">Allow website publication</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="public_allow_social" name="public_allow_social">
            <label class="form-check-label" for="public_allow_social">Allow social media</label>
          </div>
        </div>

        <!-- Anzeige-Name -->
        <div class="col-md-6">
          <label for="public_display_name" class="form-label">Display Name (public)</label>
          <input type="text" class="form-control" id="public_display_name" name="public_display_name" maxlength="200">
        </div>

        <!-- Projekt-Kurzbeschreibung -->
        <div class="col-md-6">
          <label for="summary_short" class="form-label">Short Summary (one-liner)</label>
          <input type="text" class="form-control" id="summary_short" name="summary_short" maxlength="300">
        </div>

        <!-- Projektstory -->
        <div class="col-12">
          <label for="summary_long" class="form-label">Project Story</label>
          <textarea class="form-control" id="summary_long" name="summary_long" rows="3"></textarea>
        </div>

        <div class="col-md-6">
          <label for="project_purpose" class="form-label">Project Purpose</label>
          <textarea class="form-control" id="project_purpose" name="project_purpose" rows="2"></textarea>
        </div>
        <div class="col-md-6">
          <label for="project_use_case" class="form-label">Use Case</label>
          <textarea class="form-control" id="project_use_case" name="project_use_case" rows="2"></textarea>
        </div>

        <div class="col-md-6">
          <label for="learning_points" class="form-label">Learning Points</label>
          <textarea class="form-control" id="learning_points" name="learning_points" rows="2"></textarea>
        </div>
        <div class="col-md-6">
          <label for="background_info" class="form-label">Background Info</label>
          <textarea class="form-control" id="background_info" name="background_info" rows="2"></textarea>
        </div>

        <div class="col-md-6">
          <label for="project_url" class="form-label">Project URL (GitHub, docs, etc.)</label>
          <input type="url" class="form-control" id="project_url" name="project_url" maxlength="300">
        </div>

        <div class="col-md-6">
          <label for="image_main" class="form-label">Main Image (URL)</label>
          <input type="text" class="form-control" id="image_main" name="image_main" maxlength="300">
        </div>

        <div class="col-md-6">
          <label for="tags" class="form-label">Tags (comma separated)</label>
          <input type="text" class="form-control" id="tags" name="tags" maxlength="300" placeholder="mechanics, prototype, drone">
        </div>

        <!-- Material -->
        <div class="col-md-6">
          <label for="material_id" class="form-label">
            <i class="bi bi-box-seam me-1"></i>
            Material
          </label>
          <select
            id="material_id"
            name="material_id"
            class="form-select"
          >
            <option value="">– Please select –</option>
            {% for m in materials %}
              <option value="{{ m.id }}">{{ m.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Color mit Vorschau -->
        <div class="col-md-6">
          <label for="color_id" class="form-label">
            <i class="bi bi-palette me-1"></i>
            Color
          </label>
          <div class="input-group">
            <select
              id="color_id"
              name="color_id"
              class="form-select"
              onchange="updateColorPreview()"
            >
              <option value="">– Please select –</option>
              {% for c in colors %}
                <option value="{{ c.id }}"
                        data-hex="{{ c.hex_code if c.hex_code else '' }}">
                  {{ c.name }}{% if c.hex_code %} ({{ c.hex_code }}){% endif %}
                </option>
              {% endfor %}
            </select>
            <span class="input-group-text p-0">
              <div id="colorPreview"
                   style="width: 32px; height: 32px; border-radius: 4px;
                          border: 1px solid #ccc; background-color: transparent;">
              </div>
            </span>
          </div>
        </div>

        {% if current_user.role == 'admin' %}
        <!-- Status (nur Admin) -->
        <div class="col-md-6">
          <label for="status" class="form-label">
            <i class="bi bi-flag me-1"></i>
            Status
          </label>
          <select
            id="status"
            name="status"
            class="form-select"
          >
            {% for value, label in order_statuses %}
              <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% endif %}

      </div>

      <div class="mb-3">
        <label for="model_file" class="form-label">
            3D-Modell hochladen (STL oder 3MF)
        </label>
        <input class="form-control"
               type="file"
               id="model_file"
               name="model_file"
               accept=".stl,.3mf">
        <div class="form-text">
            Erlaubte Formate: .stl, .3mf
        </div>
    </div>

      <!-- Buttons -->
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-save me-1"></i>
          Create Order
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left me-1"></i>
          Back to dashboard
        </a>
      </div>

    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function updateColorPreview() {
  const select = document.getElementById("color_id");
  const preview = document.getElementById("colorPreview");

  if (!select || !preview) return;

  const selected = select.options[select.selectedIndex];
  const hex = selected.getAttribute("data-hex");

  if (hex && /^#([0-9A-Fa-f]{6})$/.test(hex)) {
    preview.style.backgroundColor = hex;
    preview.style.border = "1px solid #ccc";
  } else {
    preview.style.backgroundColor = "transparent";
    preview.style.border = "1px solid #ccc";
  }
}
</script>
{% endblock %}
